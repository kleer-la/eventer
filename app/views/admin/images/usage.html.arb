# app/views/admin/images/usage.html.arb
panel "Image Usage - #{image_key}" do
  columns do
    column do
      panel 'Image Preview' do
        image_tag image_url, style: 'max-width: 300px'
      end

      panel 'Actions' do
        if usage.any?
          div class: 'delete-warning' do
            para 'This image cannot be deleted as it is currently in use. Please remove all references first.',
                 style: 'color: red;'
          end
        else
          div class: 'delete-action' do
            button_to 'Delete Image',
                      admin_images_delete_path(bucket: image_bucket, key: image_key),
                      method: :delete,
                      data: { confirm: 'Are you sure you want to delete this image?' },
                      class: 'button'
          end
        end
      end
    end

    column do
      panel 'Usage Details' do
        if usage.any?
          usage.each do |model, instances|
            h3 model.to_s.titleize
            table_for instances do
              column :id
              column :slug if instances.first[:slug].present?
              column :field
              column :type
              column 'Link' do |instance|
                # Try to create admin link, fallback to ID if no admin resource exists

                link_to "View #{model}", send("admin_#{model}_path", instance[:id])
              rescue StandardError
                # Check if this model has an associated assessment or other parent
                case model.to_s
                when 'question', 'question_group', 'answer'
                  if instance[:id] && defined?(Question) && model.to_s == 'question'
                    question = Question.find_by(id: instance[:id])
                    if question&.assessment_id
                      link_to 'View Assessment', admin_assessment_path(question.assessment_id)
                    else
                      "Question ID: #{instance[:id]}"
                    end
                  elsif instance[:id] && defined?(QuestionGroup) && model.to_s == 'question_group'
                    group = QuestionGroup.find_by(id: instance[:id])
                    if group&.assessment_id
                      link_to 'View Assessment', admin_assessment_path(group.assessment_id)
                    else
                      "Question Group ID: #{instance[:id]}"
                    end
                  elsif instance[:id] && defined?(Answer) && model.to_s == 'answer'
                    answer = Answer.find_by(id: instance[:id])
                    if answer&.question&.assessment_id
                      link_to 'View Assessment', admin_assessment_path(answer.question.assessment_id)
                    else
                      "Answer ID: #{instance[:id]}"
                    end
                  else
                    "#{model.to_s.titleize} ID: #{instance[:id]}"
                  end
                else
                  "#{model.to_s.titleize} ID: #{instance[:id]}"
                end
              end
            end
          end
        else
          para 'This image is not currently in use in any model.'
        end
      end
    end
  end
  
  panel 'Important Note', class: 'disclaimer' do
    div class: 'disclaimer-content', style: 'background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px;' do
      h4 'Image Reference Detection Limitations', style: 'margin-top: 0; color: #856404;'
      para 'We make our best effort to detect all internal references to this image within the application database. However, please consider the following limitations:', style: 'color: #856404; margin-bottom: 10px;'
      ul style: 'color: #856404; margin: 0; padding-left: 20px;' do
        li 'External references (links from other websites) are not detected'
        li 'Static usage in website templates, CSS files, or hardcoded HTML is not tracked'
        li 'References in cached content or external systems may not be visible'
        li 'ActionText (rich text) content may contain additional image references'
      end
      para 'Always verify manually before deleting important images, especially if they are used in public-facing content.', style: 'color: #856404; margin-top: 10px; font-weight: bold;'
    end
  end
end
