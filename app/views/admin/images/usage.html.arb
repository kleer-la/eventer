# app/views/admin/images/usage.html.arb
panel "Image Usage - #{image_key}" do
  columns do
    column do
      panel 'Image Preview' do
        image_tag image_url, style: 'max-width: 300px'
      end

      panel 'Actions' do
        if usage.any?
          div class: 'delete-warning' do
            para 'This image cannot be deleted as it is currently in use. Please remove all references first.',
                 style: 'color: red;'
          end
        else
          div class: 'delete-action' do
            button_to 'Delete Image',
                      admin_images_delete_path(bucket: image_bucket, key: image_key),
                      method: :delete,
                      data: { confirm: 'Are you sure you want to delete this image?' },
                      class: 'button'
          end
        end
      end
    end

    column do
      panel 'Usage Details' do
        if usage.any?
          usage.each do |model, instances|
            h3 model.to_s.titleize
            table_for instances do
              column :id
              column :slug if instances.first[:slug].present?
              column :field
              column :type
              column 'Link' do |instance|
                # Try to create admin link, fallback to ID if no admin resource exists

                link_to "View #{model}", send("admin_#{model}_path", instance[:id])
              rescue StandardError
                # Check if this model has an associated assessment or other parent
                case model.to_s
                when 'question', 'question_group', 'answer'
                  if instance[:id] && defined?(Question) && model.to_s == 'question'
                    question = Question.find_by(id: instance[:id])
                    if question&.assessment_id
                      link_to 'View Assessment', admin_assessment_path(question.assessment_id)
                    else
                      "Question ID: #{instance[:id]}"
                    end
                  elsif instance[:id] && defined?(QuestionGroup) && model.to_s == 'question_group'
                    group = QuestionGroup.find_by(id: instance[:id])
                    if group&.assessment_id
                      link_to 'View Assessment', admin_assessment_path(group.assessment_id)
                    else
                      "Question Group ID: #{instance[:id]}"
                    end
                  elsif instance[:id] && defined?(Answer) && model.to_s == 'answer'
                    answer = Answer.find_by(id: instance[:id])
                    if answer&.question&.assessment_id
                      link_to 'View Assessment', admin_assessment_path(answer.question.assessment_id)
                    else
                      "Answer ID: #{instance[:id]}"
                    end
                  else
                    "#{model.to_s.titleize} ID: #{instance[:id]}"
                  end
                else
                  "#{model.to_s.titleize} ID: #{instance[:id]}"
                end
              end
            end
          end
        else
          para 'This image is not currently in use in any model.'
        end
      end
    end
  end
end
